{"componentChunkName":"component---src-templates-blog-post-js","path":"/projects/install-nodered-with-docker-and-cloudflare","result":{"data":{"post":{"html":"<h2>Node-RED</h2>\n<p>A visual tool for wiring the Internet of Things.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1000px; max-width: clamp(200px, calc(1.5151515151515151* 80vh), 1000px); max-height: 1000px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8376ee051fbea0a9cc0c25961eb90c0b/719d3/poster.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACHElEQVQ4y5WSS2/TQBSF/adpi9qERkqrdgXKL6hgAwtYILEBIYQIUnelgkjQ1K1jjzNO/CaOH43tD81ULbS81CMdacayv3uP7zX2d/oMHj1kd3eHrc4We/t79Ho91tY32Njs0Ok+4N76Bvc7PTY3t1hbW6PT6Wj3+30ODg4YDAZsb2/T7XYxkizHXxS0QJ3X2lp1AZmEtgIuoBDcVlEUv90N82jE8NkrZs4Uz50zsz3yvCCL54TWZ9LAwxUnHB8+xRIn1A3UdU3TNHieRxzHhGFImqb6bgTWGeeHH8iiEF+GOKcOYixIowWq18gdc3z4ktdvHjN8+4RYmrqbtm3Isgzf9zWsLEtmsxmGnI04/vKcJJXky5J8saTKK+qLlfqKVZVTLRe0VQmrira+uI4YRhG2bRPMZyRxjCMEhmmafBwOiaOIP2lVN3y1JJ++WTquJc95f/SOUzEmTRKk5yG/F5R1w1x16FkjRsMXpKG8jNI0tG2rfRmtvVEgL3OSLKaocpIkYWI7jG2PMEzw5BTDdQVRGFDkuUp4DfsVePvZlbwgYjSRONInCGLkdIoxmUyYz+csl8sbgCv9rYCSmrCC+EFAUZZIKTGEEHo6t4H/s1KSpgjXxXYcHV8D1ZTUIdeR2zsB4zDCNs+Y2s7PPVS7tFgsrju8i0I/YKKAQmiG2klDbXkURdrqrFpXcFXoX1bvqF9lnpmcW5Y+u67LD8ityYg/V4JuAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/8376ee051fbea0a9cc0c25961eb90c0b/70216/poster.webp 250w,\n/static/8376ee051fbea0a9cc0c25961eb90c0b/61bdd/poster.webp 500w,\n/static/8376ee051fbea0a9cc0c25961eb90c0b/d0dac/poster.webp 1000w,\n/static/8376ee051fbea0a9cc0c25961eb90c0b/71d60/poster.webp 1258w\"\n              sizes=\"(max-width: 1000px) 100vw, 1000px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/8376ee051fbea0a9cc0c25961eb90c0b/41b2e/poster.png 250w,\n/static/8376ee051fbea0a9cc0c25961eb90c0b/36a81/poster.png 500w,\n/static/8376ee051fbea0a9cc0c25961eb90c0b/ea415/poster.png 1000w,\n/static/8376ee051fbea0a9cc0c25961eb90c0b/719d3/poster.png 1258w\"\n            sizes=\"(max-width: 1000px) 100vw, 1000px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/8376ee051fbea0a9cc0c25961eb90c0b/ea415/poster.png\"\n            alt=\"poster\"\n            title=\"poster\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h2>Overview</h2>\n<p>I am planning on writing a series of different posts on using <a href=\"https://nodered.org/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Node-RED</a> and so this is the first post of the series. It will have a small twist, in that I will be setting it up using docker-compose with a <a href=\"https://letsencrypt.org/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Let’s Encrypt</a> certificate using Traefik for the reverse proxy and lastly, <a href=\"https://www.cloudflare.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">CloudFlare</a> for DNS.</p>\n<p>As a bonus, I will also add <a href=\"https://github.com/containrrr/watchtower\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Watchtower</a> to automate updates of <a href=\"https://traefik.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Traefik</a> and [Node-Red.]</p>\n<h2>Goals</h2>\n<p>After finishing the instructions in this blog post, you will have:</p>\n<ul>\n<li>Used docker-compose</li>\n<li><a href=\"https://nodered.org/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Node-RED</a> installed without exposing the ports using docker</li>\n<li><a href=\"https://traefik.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Traefik</a> installed as reverse-proxy</li>\n<li>Ability to have multiple apps behind unique subdomains on your domain.tld using <a href=\"https://letsencrypt.org/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Let’s Encrypt</a> certificates</li>\n</ul>\n<h2>Requirements</h2>\n<ul>\n<li>Linux Host for Docker and <a href=\"https://nodered.org/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Node-RED</a> - Can be a VPS or Raspberry Pi ect.</li>\n<li><a href=\"https://www.cloudflare.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">CloudFlare</a> account with <a href=\"https://support.cloudflare.com/hc/en-us/articles/200167836-Where-do-I-find-my-Cloudflare-API-key-\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">API key</a></li>\n<li>Domain with DNS hosted by <a href=\"https://www.cloudflare.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">CloudFlare</a></li>\n<li>You will need to point a *.domain.tld record to your Linux host. The reason for this is, we will be using subdomains to point to different services running in docker. In this example, I will be pointing nodered.domain.tld to my nodered container for easy access.</li>\n</ul>\n<h2>Preperation</h2>\n<p>Usually I have a separate volume for my data mounted on /data and on this volume I will create a folder named <em>docker</em> with all my files in.</p>\n<p>We will create 2 files /data/docker to start with.</p>\n<p>First file will contain our authentication and keys: <code class=\"language-text\">.env</code></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">PUID</span><span class=\"token operator\">=</span><span class=\"token number\">1001</span>\n<span class=\"token assign-left variable\">PGID</span><span class=\"token operator\">=</span><span class=\"token number\">1001</span>\n<span class=\"token assign-left variable\">TZ</span><span class=\"token operator\">=</span>Africa/Johannesburg\n<span class=\"token assign-left variable\">USERDIR</span><span class=\"token operator\">=</span>/data\n\n<span class=\"token assign-left variable\">DOMAINNAME</span><span class=\"token operator\">=</span>domain.tld\n<span class=\"token assign-left variable\">CLOUDFLARE_EMAIL</span><span class=\"token operator\">=</span>cloudflare@domain.tld\n<span class=\"token assign-left variable\">CLOUDFLARE_API_KEY</span><span class=\"token operator\">=</span>abcdefghiklmnopqrstvwxyz01234567897e8c6\n\n<span class=\"token assign-left variable\">HTTP_USERNAME</span><span class=\"token operator\">=</span>tinuva\n<span class=\"token assign-left variable\">HTTP_PASSWORD</span><span class=\"token operator\">=</span><span class=\"token variable\">$apr1</span><span class=\"token variable\">$bJ77aaaaaaaaaaaaaaaaaaaaaaaaaaax</span>/vO0\n<span class=\"token assign-left variable\">API_HTTP_USERNAME</span><span class=\"token operator\">=</span>nodered\n<span class=\"token assign-left variable\">API_HTTP_PASSWORD</span><span class=\"token operator\">=</span><span class=\"token variable\">$apr1</span><span class=\"token variable\">$bbbbbbbbbbbbbbbbbbbbbbbbbnElz47L1</span></code></pre></div>\n<p>To do:</p>\n<ol>\n<li>Replace <code class=\"language-text\">domain.tld</code> with your domain that is hosted with <a href=\"https://www.cloudflare.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">CloudFlare</a></li>\n<li>Set your timezone</li>\n<li>Create a .htpass file with <a href=\"http://aspirine.org/htpasswd_en.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">HTPASSWD Generator</a> then place the username and passwords into the above fields.</li>\n</ol>\n<p>Initially we will only use the HTTP_USERNAME and HTTP_PASSWORD. The API versions will be used at a later stage when we create an API endpoint using <a href=\"https://nodered.org/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Node-RED</a></p>\n<p>Next we will create a <code class=\"language-text\">docker-compose.yml</code> file/</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'2.1'</span>\n\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">nodered</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nodered/node<span class=\"token punctuation\">-</span>red<span class=\"token punctuation\">-</span>docker<span class=\"token punctuation\">:</span>slim<span class=\"token punctuation\">-</span>v10\n    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> nodered\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> $<span class=\"token punctuation\">{</span>USERDIR<span class=\"token punctuation\">}</span>/docker/nodered/data<span class=\"token punctuation\">:</span>/data\n      <span class=\"token punctuation\">-</span> /etc/localtime<span class=\"token punctuation\">:</span>/etc/localtime\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always\n    <span class=\"token key atrule\">mem_limit</span><span class=\"token punctuation\">:</span> 100m\n    <span class=\"token key atrule\">cpu_shares</span><span class=\"token punctuation\">:</span> <span class=\"token number\">50</span>\n    <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"traefik.enable=true\"</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"traefik.backend=nodered\"</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"traefik.frontend.redirect.entryPoint=https\"</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"traefik.port=1880\"</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"traefik.protocol=http\"</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"traefik.docker.network=docker_traefik_proxy\"</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"traefik.ifttt.frontend.rule=Host:nodered.${DOMAINNAME};Path:/ifttt\"</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"traefik.ifttt.frontend.auth.basic.users=${API_HTTP_USERNAME}:${API_HTTP_PASSWORD}\"</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"traefik.web.frontend.rule=Host:nodered.${DOMAINNAME}\"</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"traefik.web.frontend.auth.basic.users=${HTTP_USERNAME}:${HTTP_PASSWORD}\"</span>\n      <span class=\"token punctuation\">-</span> com.centurylinklabs.watchtower.enable=true\n\n  <span class=\"token key atrule\">traefik</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">hostname</span><span class=\"token punctuation\">:</span> traefik\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> traefik<span class=\"token punctuation\">:</span>latest\n    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> traefik\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always\n    <span class=\"token key atrule\">domainname</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>DOMAINNAME<span class=\"token punctuation\">}</span>\n    <span class=\"token key atrule\">cpu_shares</span><span class=\"token punctuation\">:</span> <span class=\"token number\">30</span>\n    <span class=\"token key atrule\">mem_limit</span><span class=\"token punctuation\">:</span> 250m\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token datetime number\">80:80</span>\n      <span class=\"token punctuation\">-</span> 443<span class=\"token punctuation\">:</span><span class=\"token number\">443</span>\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> CLOUDFLARE_EMAIL=$<span class=\"token punctuation\">{</span>CLOUDFLARE_EMAIL<span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">-</span> CLOUDFLARE_API_KEY=$<span class=\"token punctuation\">{</span>CLOUDFLARE_API_KEY<span class=\"token punctuation\">}</span>\n    <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"traefik.enable=true\"</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"traefik.backend=traefik\"</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"traefik.frontend.rule=Host:traefik.${DOMAINNAME}\"</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"traefik.frontend.redirect.entryPoint=https\"</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"traefik.port=8080\"</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"traefik.docker.network=docker_traefik_proxy\"</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"traefik.frontend.auth.basic.users=${HTTP_USERNAME}:${HTTP_PASSWORD}\"</span>\n      <span class=\"token punctuation\">-</span> com.centurylinklabs.watchtower.enable=true\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> /var/run/docker.sock<span class=\"token punctuation\">:</span>/var/run/docker.sock<span class=\"token punctuation\">:</span>ro\n      <span class=\"token punctuation\">-</span> $<span class=\"token punctuation\">{</span>USERDIR<span class=\"token punctuation\">}</span>/docker/traefik<span class=\"token punctuation\">:</span>/etc/traefik\n      <span class=\"token punctuation\">-</span> $<span class=\"token punctuation\">{</span>USERDIR<span class=\"token punctuation\">}</span>/docker/shared<span class=\"token punctuation\">:</span>/shared\n\n  <span class=\"token key atrule\">watchtower</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> v2tec/watchtower<span class=\"token punctuation\">:</span>latest\n    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> watchtower\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> /var/run/docker.sock<span class=\"token punctuation\">:</span>/var/run/docker.sock\n      <span class=\"token punctuation\">-</span> /etc/localtime<span class=\"token punctuation\">:</span>/etc/localtime<span class=\"token punctuation\">:</span>ro\n    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>schedule \"0 30 5 * * <span class=\"token important\">*\"</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>cleanup <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>label<span class=\"token punctuation\">-</span>enable\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always\n    <span class=\"token key atrule\">mem_limit</span><span class=\"token punctuation\">:</span> 50m\n    <span class=\"token key atrule\">cpu_shares</span><span class=\"token punctuation\">:</span> <span class=\"token number\">25</span></code></pre></div>\n<p>We also need to create folders and set ownership to match the above.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mkdir</span> /data/docker/shared\n<span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /data/docker/nodered/data\n<span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /data/docker/traefik/acme\n\n<span class=\"token function\">touch</span> /data/docker/traefik/rules.toml\n<span class=\"token function\">touch</span> /data/docker/traefik/acme/acme.json\n<span class=\"token function\">chmod</span> <span class=\"token number\">600</span> /data/docker/traefik/acme/acme.json\n\n<span class=\"token function\">chown</span> <span class=\"token parameter variable\">-R</span> <span class=\"token number\">1001.1001</span> /data/docker/nodered\n<span class=\"token function\">chown</span> <span class=\"token parameter variable\">-R</span> <span class=\"token number\">1001.1001</span>  /data/docker/traefik\n<span class=\"token function\">chown</span> <span class=\"token number\">1001.1001</span>  /data/docker/shared</code></pre></div>\n<p>Create <a href=\"https://traefik.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Traefik</a>’s config file: <code class=\"language-text\">/data/docker/traefik/traefik.toml</code></p>\n<div class=\"gatsby-highlight\" data-language=\"toml\"><pre class=\"language-toml\"><code class=\"language-toml\"><span class=\"token comment\">#debug = true</span>\n\n<span class=\"token key property\">logLevel</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"ERROR\"</span> <span class=\"token comment\">#DEBUG, INFO, WARN, ERROR, FATAL, PANIC</span>\n<span class=\"token key property\">InsecureSkipVerify</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span> \n<span class=\"token key property\">defaultEntryPoints</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"https\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"http\"</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token comment\"># WEB interface of Traefik - it will show web page with overview of frontend and backend configurations </span>\n<span class=\"token punctuation\">[</span><span class=\"token table class-name\">api</span><span class=\"token punctuation\">]</span>\n  <span class=\"token key property\">entryPoint</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"traefik\"</span>\n  <span class=\"token key property\">dashboard</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n  <span class=\"token key property\">address</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\":8080\"</span>\n\n<span class=\"token comment\"># Force HTTPS</span>\n<span class=\"token punctuation\">[</span><span class=\"token table class-name\">entryPoints</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">[</span><span class=\"token table class-name\">entryPoints.http</span><span class=\"token punctuation\">]</span>\n  <span class=\"token key property\">address</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\":80\"</span>\n    <span class=\"token punctuation\">[</span><span class=\"token table class-name\">entryPoints.http.redirect</span><span class=\"token punctuation\">]</span>\n    <span class=\"token key property\">entryPoint</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"https\"</span>\n  <span class=\"token punctuation\">[</span><span class=\"token table class-name\">entryPoints.https</span><span class=\"token punctuation\">]</span>\n  <span class=\"token key property\">address</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\":443\"</span>\n    <span class=\"token punctuation\">[</span><span class=\"token table class-name\">entryPoints.https.tls</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token table class-name\">file</span><span class=\"token punctuation\">]</span>\n  <span class=\"token key property\">watch</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n  <span class=\"token key property\">filename</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"/etc/traefik/rules.toml\"</span>\n\n<span class=\"token comment\"># Let's encrypt configuration</span>\n<span class=\"token punctuation\">[</span><span class=\"token table class-name\">acme</span><span class=\"token punctuation\">]</span>\n<span class=\"token key property\">email</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"email@domain.com\"</span> <span class=\"token comment\">#any email id will work</span>\n<span class=\"token key property\">storage</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"/etc/traefik/acme/acme.json\"</span>\n<span class=\"token key property\">entryPoint</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"https\"</span>\n<span class=\"token key property\">acmeLogging</span><span class=\"token punctuation\">=</span><span class=\"token boolean\">true</span> \n<span class=\"token key property\">onDemand</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">false</span> <span class=\"token comment\">#create certificate when container is created</span>\n<span class=\"token punctuation\">[</span><span class=\"token table class-name\">acme.dnsChallenge</span><span class=\"token punctuation\">]</span>\n  <span class=\"token key property\">provider</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"cloudflare\"</span>\n  <span class=\"token key property\">delayBeforeCheck</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">300</span>\n<span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token table class-name\">acme.domains</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n   <span class=\"token key property\">main</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"domain.tld\"</span>\n<span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token table class-name\">acme.domains</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n   <span class=\"token key property\">main</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"*.domain.tld\"</span>\n   \n<span class=\"token comment\"># Connection to docker host system (docker.sock)</span>\n<span class=\"token punctuation\">[</span><span class=\"token table class-name\">docker</span><span class=\"token punctuation\">]</span>\n<span class=\"token key property\">endpoint</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"unix:///var/run/docker.sock\"</span>\n<span class=\"token key property\">domain</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"domain.tld\"</span>\n<span class=\"token key property\">watch</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n<span class=\"token comment\"># This will hide all docker containers that don't have explicitly  </span>\n<span class=\"token comment\"># set label to \"enable\"</span>\n<span class=\"token key property\">exposedbydefault</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">false</span></code></pre></div>\n<p>Replace/Configure:</p>\n<ol>\n<li><a href=\"mailto:email@domain.com\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">email@domain.com</a>: with your email.</li>\n<li>domain.tld: with your private domain name.</li>\n<li>InsecureSkipVerify = true: I had to add at the beginning to allow some apps (eg. UniFi controller) be accessible through Traefik.</li>\n<li>provider = “cloudflare”: Change to your DNS provider for DNS challenge.</li>\n<li>exposedbydefault = false: This will force you to use traefik.enable=true label in docker compose to put apps behind traefik.</li>\n</ol>\n<ul>\n<li>If you want to use another DNS provider instead of CloudFlare, review the list of <a href=\"https://docs.traefik.io/configuration/acme/#provider\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">available providers</a> on the Traefik documentation</li>\n</ul>\n<h2>Install Docker</h2>\n<p>Ok lets install docker.</p>\n<p>I have a CentOS host which the following work:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> yum <span class=\"token function\">install</span> <span class=\"token parameter variable\">-y</span> yum-utils <span class=\"token punctuation\">\\</span>\n  device-mapper-persistent-data <span class=\"token punctuation\">\\</span>\n  lvm2\n\n<span class=\"token function\">sudo</span> yum-config-manager <span class=\"token punctuation\">\\</span>\n    --add-repo <span class=\"token punctuation\">\\</span>\n    https://download.docker.com/linux/centos/docker-ce.repo\n\n<span class=\"token function\">sudo</span> yum <span class=\"token function\">install</span> docker-ce docker-ce-cli containerd.io\n\nsystemctl start <span class=\"token function\">docker</span>\nsystemctl <span class=\"token builtin class-name\">enable</span> <span class=\"token function\">docker</span></code></pre></div>\n<p>Reference: <a href=\"https://docs.docker.com/install/linux/docker-ce/centos/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://docs.docker.com/install/linux/docker-ce/centos/</a></p>\n<p>On Ubuntu the commands will be:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> update\n\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> <span class=\"token punctuation\">\\</span>\n    apt-transport-https <span class=\"token punctuation\">\\</span>\n    ca-certificates <span class=\"token punctuation\">\\</span>\n    <span class=\"token function\">curl</span> <span class=\"token punctuation\">\\</span>\n    gnupg-agent <span class=\"token punctuation\">\\</span>\n    software-properties-common\n\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-fsSL</span> https://download.docker.com/linux/ubuntu/gpg <span class=\"token operator\">|</span> <span class=\"token function\">sudo</span> apt-key <span class=\"token function\">add</span> -\n\n<span class=\"token function\">sudo</span> add-apt-repository <span class=\"token punctuation\">\\</span>\n   <span class=\"token string\">\"deb [arch=amd64] https://download.docker.com/linux/ubuntu \\\n   <span class=\"token variable\"><span class=\"token variable\">$(</span>lsb_release <span class=\"token parameter variable\">-cs</span><span class=\"token variable\">)</span></span> \\\n   stable\"</span>\n\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> update\n\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> docker-ce docker-ce-cli containerd.io</code></pre></div>\n<p>Reference: <a href=\"https://docs.docker.com/install/linux/docker-ce/ubuntu/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://docs.docker.com/install/linux/docker-ce/ubuntu/</a></p>\n<h2>Install docker-compose</h2>\n<p>First confirm <code class=\"language-text\">pip</code> is installed:</p>\n<p>On CentOS:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">yum <span class=\"token function\">install</span> python-pip</code></pre></div>\n<p>On Ubuntu:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">apt</span> <span class=\"token function\">install</span> python-pip</code></pre></div>\n<p>Then install docker-compose:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">pip <span class=\"token function\">install</span> <span class=\"token function\">docker-compose</span></code></pre></div>\n<h2>Start containers with docker-compose</h2>\n<p>Starting the containers is as simple as:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">cd</span> /data/docker <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">docker-compose</span> up <span class=\"token parameter variable\">-d</span> --remove-orphans <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">docker-compose</span> logs <span class=\"token parameter variable\">-f</span> <span class=\"token parameter variable\">--tail</span> <span class=\"token number\">10</span></code></pre></div>\n<p>You should see output like the following:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@thor docker<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /data/docker &amp;&amp; docker-compose up -d --remove-orphans &amp;&amp; docker-compose logs -f --tail 10</span>\nPulling traefik <span class=\"token punctuation\">(</span>traefik:latest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">..</span>.\nlatest: Pulling from library/traefik\nd572f7c8e983: Pull complete\nd62b0f6adf29: Pull complete\nDigest: sha256:02cfdb77b0cd82d973dffb3dafe498283f82399bd75b335797d7f0fe3ebeccb8\nStatus: Downloaded newer image <span class=\"token keyword\">for</span> traefik:latest\nPulling watchtower <span class=\"token punctuation\">(</span>v2tec/watchtower:latest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">..</span>.\nlatest: Pulling from v2tec/watchtower\na5415f98d52c: Pull complete\nc3f7208ad77c: Pull complete\n169c1e589d74: Pull complete\nDigest: sha256:4cb6299fe87dcbfe0f13dcc5a11bf44bd9628a4dae0035fecb8cc2b88ff0fc79\nStatus: Downloaded newer image <span class=\"token keyword\">for</span> v2tec/watchtower:latest\nPulling nodered <span class=\"token punctuation\">(</span>nodered/node-red-docker:slim-v10<span class=\"token punctuation\">)</span><span class=\"token punctuation\">..</span>.\nslim-v10: Pulling from nodered/node-red-docker\ne7c96db7181b: Pull complete\nbbec46749066: Pull complete\n89e5cf82282d: Pull complete\n5de6895db72f: Pull complete\n6c5493c0ae88: Pull complete\n6ace8e934b90: Pull complete\ne37b30d9d482: Pull complete\n95734c8da825: Pull complete\ncf430c1fac0c: Pull complete\nDigest: sha256:42126aab7325a3133f47e0a89bb14a3985c8d4daeb8d8a3c0e19cfe9137e1c79\nStatus: Downloaded newer image <span class=\"token keyword\">for</span> nodered/node-red-docker:slim-v10\nCreating traefik    <span class=\"token punctuation\">..</span>. <span class=\"token keyword\">done</span>\nCreating nodered    <span class=\"token punctuation\">..</span>. <span class=\"token keyword\">done</span>\nCreating watchtower <span class=\"token punctuation\">..</span>. <span class=\"token keyword\">done</span>\nAttaching to nodered, watchtower, traefik\nnodered       <span class=\"token operator\">|</span>\nnodered       <span class=\"token operator\">|</span> <span class=\"token operator\">></span> node-red-docker@1.0.0 start /usr/src/node-red\nnodered       <span class=\"token operator\">|</span> <span class=\"token operator\">></span> <span class=\"token function\">node</span> <span class=\"token variable\">$NODE_OPTIONS</span> node_modules/node-red/red.js <span class=\"token parameter variable\">-v</span> <span class=\"token variable\">$FLOWS</span> <span class=\"token string\">\"--userDir\"</span> <span class=\"token string\">\"/data\"</span>\nnodered       <span class=\"token operator\">|</span>\nwatchtower    <span class=\"token operator\">|</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token string\">\"2019-07-22T17:12:26+02:00\"</span> <span class=\"token assign-left variable\">level</span><span class=\"token operator\">=</span>info <span class=\"token assign-left variable\">msg</span><span class=\"token operator\">=</span><span class=\"token string\">\"First run: 2019-07-23 05:30:00 +0200 SAST\"</span>\nnodered       <span class=\"token operator\">|</span> <span class=\"token number\">22</span> Jul <span class=\"token number\">17</span>:12:28 - <span class=\"token punctuation\">[</span>info<span class=\"token punctuation\">]</span>\nnodered       <span class=\"token operator\">|</span>\nnodered       <span class=\"token operator\">|</span> Welcome to Node-RED\nnodered       <span class=\"token operator\">|</span> <span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">=</span>\nnodered       <span class=\"token operator\">|</span>\nnodered       <span class=\"token operator\">|</span> <span class=\"token number\">22</span> Jul <span class=\"token number\">17</span>:12:28 - <span class=\"token punctuation\">[</span>info<span class=\"token punctuation\">]</span> Node-RED version: v0.20.7\nnodered       <span class=\"token operator\">|</span> <span class=\"token number\">22</span> Jul <span class=\"token number\">17</span>:12:28 - <span class=\"token punctuation\">[</span>info<span class=\"token punctuation\">]</span> Node.js  version: v10.16.0\nnodered       <span class=\"token operator\">|</span> <span class=\"token number\">22</span> Jul <span class=\"token number\">17</span>:12:28 - <span class=\"token punctuation\">[</span>info<span class=\"token punctuation\">]</span> Linux <span class=\"token number\">3.10</span>.0-957.21.3.el7.x86_64 x64 LE\nnodered       <span class=\"token operator\">|</span> <span class=\"token number\">22</span> Jul <span class=\"token number\">17</span>:12:28 - <span class=\"token punctuation\">[</span>info<span class=\"token punctuation\">]</span> Loading palette nodes\nnodered       <span class=\"token operator\">|</span> <span class=\"token number\">22</span> Jul <span class=\"token number\">17</span>:12:30 - <span class=\"token punctuation\">[</span>warn<span class=\"token punctuation\">]</span> rpi-gpio <span class=\"token builtin class-name\">:</span> Raspberry Pi specific <span class=\"token function\">node</span> <span class=\"token builtin class-name\">set</span> inactive\nnodered       <span class=\"token operator\">|</span> <span class=\"token number\">22</span> Jul <span class=\"token number\">17</span>:12:30 - <span class=\"token punctuation\">[</span>warn<span class=\"token punctuation\">]</span> rpi-gpio <span class=\"token builtin class-name\">:</span> Cannot <span class=\"token function\">find</span> Pi RPi.GPIO python library\nnodered       <span class=\"token operator\">|</span> <span class=\"token number\">22</span> Jul <span class=\"token number\">17</span>:12:30 - <span class=\"token punctuation\">[</span>info<span class=\"token punctuation\">]</span> Settings <span class=\"token function\">file</span>  <span class=\"token builtin class-name\">:</span> /data/settings.js\nnodered       <span class=\"token operator\">|</span> <span class=\"token number\">22</span> Jul <span class=\"token number\">17</span>:12:30 - <span class=\"token punctuation\">[</span>info<span class=\"token punctuation\">]</span> Context store  <span class=\"token builtin class-name\">:</span> <span class=\"token string\">'default'</span> <span class=\"token punctuation\">[</span>module<span class=\"token operator\">=</span>memory<span class=\"token punctuation\">]</span>\nnodered       <span class=\"token operator\">|</span> <span class=\"token number\">22</span> Jul <span class=\"token number\">17</span>:12:30 - <span class=\"token punctuation\">[</span>info<span class=\"token punctuation\">]</span> User directory <span class=\"token builtin class-name\">:</span> /data\nnodered       <span class=\"token operator\">|</span> <span class=\"token number\">22</span> Jul <span class=\"token number\">17</span>:12:30 - <span class=\"token punctuation\">[</span>warn<span class=\"token punctuation\">]</span> Projects disabled <span class=\"token builtin class-name\">:</span> <span class=\"token assign-left variable\">editorTheme.projects.enabled</span><span class=\"token operator\">=</span>false\nnodered       <span class=\"token operator\">|</span> <span class=\"token number\">22</span> Jul <span class=\"token number\">17</span>:12:30 - <span class=\"token punctuation\">[</span>info<span class=\"token punctuation\">]</span> Flows <span class=\"token function\">file</span>     <span class=\"token builtin class-name\">:</span> /data/flows.json\nnodered       <span class=\"token operator\">|</span> <span class=\"token number\">22</span> Jul <span class=\"token number\">17</span>:12:30 - <span class=\"token punctuation\">[</span>info<span class=\"token punctuation\">]</span> Creating new flow <span class=\"token function\">file</span>\nnodered       <span class=\"token operator\">|</span> <span class=\"token number\">22</span> Jul <span class=\"token number\">17</span>:12:30 - <span class=\"token punctuation\">[</span>warn<span class=\"token punctuation\">]</span>\nnodered       <span class=\"token operator\">|</span>\nnodered       <span class=\"token operator\">|</span> ---------------------------------------------------------------------\nnodered       <span class=\"token operator\">|</span> Your flow credentials <span class=\"token function\">file</span> is encrypted using a system-generated key.\nnodered       <span class=\"token operator\">|</span>\nnodered       <span class=\"token operator\">|</span> If the system-generated key is lost <span class=\"token keyword\">for</span> any reason, your credentials\nnodered       <span class=\"token operator\">|</span> <span class=\"token function\">file</span> will not be recoverable, you will have to delete it and re-enter\nnodered       <span class=\"token operator\">|</span> your credentials.\nnodered       <span class=\"token operator\">|</span>\nnodered       <span class=\"token operator\">|</span> You should <span class=\"token builtin class-name\">set</span> your own key using the <span class=\"token string\">'credentialSecret'</span> option <span class=\"token keyword\">in</span>\nnodered       <span class=\"token operator\">|</span> your settings file. Node-RED will <span class=\"token keyword\">then</span> re-encrypt your credentials\nnodered       <span class=\"token operator\">|</span> <span class=\"token function\">file</span> using your chosen key the next <span class=\"token function\">time</span> you deploy a change.\nnodered       <span class=\"token operator\">|</span> ---------------------------------------------------------------------\nnodered       <span class=\"token operator\">|</span>\nnodered       <span class=\"token operator\">|</span> <span class=\"token number\">22</span> Jul <span class=\"token number\">17</span>:12:30 - <span class=\"token punctuation\">[</span>info<span class=\"token punctuation\">]</span> Server now running at http://127.0.0.1:1880/\nnodered       <span class=\"token operator\">|</span> <span class=\"token number\">22</span> Jul <span class=\"token number\">17</span>:12:30 - <span class=\"token punctuation\">[</span>info<span class=\"token punctuation\">]</span> Starting flows\nnodered       <span class=\"token operator\">|</span> <span class=\"token number\">22</span> Jul <span class=\"token number\">17</span>:12:30 - <span class=\"token punctuation\">[</span>info<span class=\"token punctuation\">]</span> Started flows</code></pre></div>\n<p>Do review the logs for a short while, it is possible that traefik failed to generate a certificate if your domain already has a TXT record for SPF.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">traefik       <span class=\"token operator\">|</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token string\">\"2019-07-22T15:26:58Z\"</span> <span class=\"token assign-left variable\">level</span><span class=\"token operator\">=</span>error <span class=\"token assign-left variable\">msg</span><span class=\"token operator\">=</span><span class=\"token string\">\"Unable to obtain ACME certificate for domains <span class=\"token entity\" title=\"\\&quot;\">\\\"</span>domain.tld<span class=\"token entity\" title=\"\\&quot;\">\\\"</span> : unable to generate a certificate for the domains [domain.tld]: acme: Error -> One or more domains had a problem:<span class=\"token entity\" title=\"\\n\">\\n</span>[domain.tld] [domain.tld] acme: error presenting token: cloudflare: failed to create TXT record: error from makeRequest: HTTP status 400: content <span class=\"token entity\" title=\"\\&quot;\">\\\"</span>{<span class=\"token entity\" title=\"\\\\\">\\\\</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>success<span class=\"token entity\" title=\"\\\\\">\\\\</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:false,<span class=\"token entity\" title=\"\\\\\">\\\\</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>errors<span class=\"token entity\" title=\"\\\\\">\\\\</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:[{<span class=\"token entity\" title=\"\\\\\">\\\\</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>code<span class=\"token entity\" title=\"\\\\\">\\\\</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:81057,<span class=\"token entity\" title=\"\\\\\">\\\\</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>message<span class=\"token entity\" title=\"\\\\\">\\\\</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\\\\">\\\\</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>The record already exists.<span class=\"token entity\" title=\"\\\\\">\\\\</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>}],<span class=\"token entity\" title=\"\\\\\">\\\\</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>messages<span class=\"token entity\" title=\"\\\\\">\\\\</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:[],<span class=\"token entity\" title=\"\\\\\">\\\\</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>result<span class=\"token entity\" title=\"\\\\\">\\\\</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:null}<span class=\"token entity\" title=\"\\&quot;\">\\\"</span><span class=\"token entity\" title=\"\\n\">\\n</span>\"</span></code></pre></div>\n<h2>Success</h2>\n<p>If all good, you should now be able to access 2 services.</p>\n<ul>\n<li><a href=\"https://traefik.domain.tld\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://traefik.domain.tld</a></li>\n<li><a href=\"https://nodered.domain.tld\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://nodered.domain.tld</a></li>\n</ul>\n<p>Both will require a password set earlier. Nodered by default doesn’t have authentication, and traefik’s dashboard also doesn’t, but that doesn’t mean we need to keep it open to the world.</p>\n<p>Initially these may show up with a self-generated certificate while <a href=\"https://traefik.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Traefik</a> work to generate and authenticate a wild-card certificate for your domain. Once this is complete, you will have a certificate issued with: Issued by: Let’s Encrypt Authority X3</p>","excerpt":"Node-RED A visual tool for wiring the Internet of Things.  Overview I am planning on writing a series of different posts on using Node-RED…","timeToRead":9,"frontmatter":{"date":"July 22, 2019","dateUnformatted":"2019-07-22","path":"/projects/install-nodered-with-docker-and-cloudflare","title":"Install Nodered using docker-compose and CloudFlare","category":"projects","tags":["howto","docker","nodered","sysadmin"],"author":"David Bezuidenhout","affiliate":"Links to Banggood or Amazon in this article are affiliate links and would support the blog if used to make a purchase.","ogKeywords":"linux, docker, nodered, node-red, cloudflare","ogDescription":"How to install Nodered using docker-compose and CloudFlare.","ogImage":{"publicURL":"/static/8376ee051fbea0a9cc0c25961eb90c0b/poster.png"}}}},"pageContext":{}},"staticQueryHashes":["1871841719","1962968773","2237466677","2943769206","316058102","3210670756","3721472473"]}