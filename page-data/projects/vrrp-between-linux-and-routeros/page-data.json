{"componentChunkName":"component---src-templates-blog-post-js","path":"/projects/vrrp-between-linux-and-routeros","result":{"data":{"post":{"html":"<h3>VRRP</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 895px; max-width: clamp(200px, calc(2.6881720430107525* 80vh), 1000px); max-height: 1000px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f49b047a76499cba25ddf92e4e71e102/02f43/vrrp.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.2%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABDklEQVQoz32RwUoDMRCG+3g+g6DP49mbCHryERQUPXnoRYoHEcGCYrFr1VC32d1kk0w+SdriuhV/GDIMM///Z2YQY6QfEiNBlvncgGogiJAQI7m+Rn92wD8w1oEERs9vbO2fcv34muuyIpWVSBeDEALGmBzOOWIUhuMpJ8MHZguTm2ZfmuOrG14+5oh3OOdzb9u2WGvRWlNV1dJhKtZ1ncO1Ft1Ydo8u2T68QNUOm8Qq/fPF5FBCJkukZVlSFAVKKZK5/OWUbNqPhCBZZFx8snd+y/1UQRSc99nZeia9KbLDvxacDtI6T5N2CNxN3tk5OGP0VGShRNid+bXD7oX6DUEgRDDGYvQCb82GeP/S3y+1Hpd+1h9nAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/f49b047a76499cba25ddf92e4e71e102/70216/vrrp.webp 250w,\n/static/f49b047a76499cba25ddf92e4e71e102/61bdd/vrrp.webp 500w,\n/static/f49b047a76499cba25ddf92e4e71e102/b0169/vrrp.webp 895w\"\n              sizes=\"(max-width: 895px) 100vw, 895px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/f49b047a76499cba25ddf92e4e71e102/41b2e/vrrp.png 250w,\n/static/f49b047a76499cba25ddf92e4e71e102/36a81/vrrp.png 500w,\n/static/f49b047a76499cba25ddf92e4e71e102/02f43/vrrp.png 895w\"\n            sizes=\"(max-width: 895px) 100vw, 895px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/f49b047a76499cba25ddf92e4e71e102/02f43/vrrp.png\"\n            alt=\"VRRP\"\n            title=\"VRRP\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>The Virtual Router Redundancy Protocol (VRRP) is a computer networking protocol that provides for automatic assignment of available Internet Protocol (IP) routers to participating hosts. This increases the availability and reliability of routing paths via automatic default gateway selections on an IP subnetwork.</p>\n<p>Reference: <a href=\"https://en.wikipedia.org/wiki/Virtual_Router_Redundancy_Protocol\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Wikipedia</a></p>\n<h3>Why</h3>\n<p>I couldn’t find a guide on how to do this. There are plenty guides setting up VRRP on RouterOS between two Mikrotik devices, plenty for Cisco, plenty for Linux using Keepalived, and so on and so forth…</p>\n<p>And so this guide…</p>\n<h3>OK but Why…</h3>\n<p>Ok but why did I need this you may ask?</p>\n<p>In my specific situation, I have a DNS server running <a href=\"https://pi-hole.net\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Pi-hole</a> which is a Linux network-level advertisement and Internet tracker blocking application which acts as a DNS sinkhole, intended for use on a private network.</p>\n<p>What happen is, this runs on a big server, however here in sunny South Africa we at times have power outages, otherwise known as load-shedding or blackouts in other countries over the world. When this happen, the fileserver loses power, but small devices like the Mikrotik Router, Ubiquiti wifi and FTTH ONT stays online…except nothing can resolve DNS when everything is configured to query the <a href=\"https://pi-hole.net\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Pi-hole</a> server which is now down.</p>\n<p>The solution was born, using VRRP to have a floating ip address, which all devices will be configured to use. When the <a href=\"https://pi-hole.net\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Pi-hole</a> server is online, the IP address will be on there, and block advertisements, and when it goes offline, the Mikrotik router will take over answering DNS queries. The failover happens very quickly, in less than a second.</p>\n<h3>RouterOS</h3>\n<p>On the Mikrotik side, its fairy easy, I will make use of a screenshot to show what is needed.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 962px; max-width: clamp(200px, calc(1.4534883720930232* 80vh), 1000px); max-height: 1000px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0c994015c30cee2a29d38526609f4aae/8d25f/routeros-vrrp.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 68.80000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACpElEQVQ4y4WSCWvjRhiG9f9/SJuj3qVkHTulLEvZXLsJvuNTlqzD0kiyZMk6feQpmtCwpbAdeHjFwDz6vm9G6T516H5/pvPtge5zh0Gnx6g3kDno9hgPXxgPRvQ7PbS5ir0ysHQDe2XK77c0sfW3fWU6N1moNivDRDc8oqTC9WKs9QbD8mV6forwU2wnIogK/CDDsAIsJ8K0N5h2iCNi/DBHWa43zEwf1YqYai6qFTLVBeOlI3M4MzH9hKg44Cc5UXGS6e8KgrR8Z5NWBOkBxXMcxv0h09GYyXDEeDDE0lcEjpBtTIYDvj/M+PynR/PKovnJoN0S/HHjcdMWtFsu7bbg+npNv2ehJPEOz/XxREBZlJKqrKiqPdswxjZtxi8aT99mDLsaw/6Cfm+FOveZTVwsI8E0Ygw9wlgJlHSXsvFChCvI0uydPMtJtjHqbMnattD1qcxdEiPEmjAM2EYh8AocZe73FYovfAIRsLbWuGtBsk0o0pw8LUiihPl0wdqyUeczXEeQxAlhGFF3lqU59ToeT9JbFAXK492jFBm6yTbcku9q2RtxlGCtTPqjCU/PPUadCerS5aU/YzI1eFk4rLwMM8ixoz1T3UW5/euWjbdBOEK2WVNkhWw79EPyJEdfapRVSVmWcrZ5UVBWFXlesN8fOJ5OslLP81Huvt5RpAXbzZYsyd5Jk5Q0TmXFurainnV9WXJk/1DH6yun45sw8AOU+9t7TtVJSsus/Be1rMorHu8faVw0uPr9E+1mm1az9R/a122aV02U+6/3HMqDPFxLf6SutBbWPz375YzGZYPL88ufojzcPshb3xd7Kf6RWnban2SF57+e87HxkQ+/ffgpyk3rRj4NTdVYzpcytYWGruqMh2NM3eTL5y9cnF38r6wW/g0OPfR+Uuh6vgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/0c994015c30cee2a29d38526609f4aae/70216/routeros-vrrp.webp 250w,\n/static/0c994015c30cee2a29d38526609f4aae/61bdd/routeros-vrrp.webp 500w,\n/static/0c994015c30cee2a29d38526609f4aae/2d7aa/routeros-vrrp.webp 962w\"\n              sizes=\"(max-width: 962px) 100vw, 962px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/0c994015c30cee2a29d38526609f4aae/41b2e/routeros-vrrp.png 250w,\n/static/0c994015c30cee2a29d38526609f4aae/36a81/routeros-vrrp.png 500w,\n/static/0c994015c30cee2a29d38526609f4aae/8d25f/routeros-vrrp.png 962w\"\n            sizes=\"(max-width: 962px) 100vw, 962px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/0c994015c30cee2a29d38526609f4aae/8d25f/routeros-vrrp.png\"\n            alt=\"WINBOX\"\n            title=\"WINBOX\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<ol>\n<li>Create a new interface in the VRRP tab</li>\n<li>Select the LAN interface, bridge1 in my case</li>\n<li>Choose a VRID, 2 here</li>\n<li>Priority is 100 (as this will be my backup)</li>\n<li>Interval is 1.00 for 1 second</li>\n<li>Setup authentication. I wanted to use ‘ah’ but settled for ‘simple’ and you need version 2 for IPv4. Version 3 of VRRP is intended for IPv6.</li>\n</ol>\n<h3>Linux</h3>\n<p>On the Linux OS side, I make use of <a href=\"https://www.keepalived.org\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Keepalived</a> which can do both virtual ip addresses using VRRP and also simple load-balancing. We will only use the former.</p>\n<p>This is the /etc/keepalived/keepalived.conf to match up to the VRRP on the Mikrotik:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token operator\">!</span> Configuration File <span class=\"token keyword\">for</span> keepalived\n\nglobal_defs <span class=\"token punctuation\">{</span>\n   router_id <span class=\"token constant\">LVS_DEVEL</span>\n   vrrp_skip_check_adv_addr\n<span class=\"token punctuation\">}</span>\n\nvrrp_instance <span class=\"token constant\">VI_1</span> <span class=\"token punctuation\">{</span>\n    state <span class=\"token constant\">BACKUP</span>\n    <span class=\"token keyword\">interface</span> <span class=\"token class-name\">eth0</span>\n    virtual_router_id <span class=\"token number\">2</span>\n    priority <span class=\"token number\">200</span>\n    advert_int <span class=\"token number\">1</span>\n    authentication <span class=\"token punctuation\">{</span>\n        auth_type <span class=\"token constant\">PASS</span>\n        auth_pass pihole77\n    <span class=\"token punctuation\">}</span>\n    virtual_ipaddress <span class=\"token punctuation\">{</span>\n        <span class=\"token number\">192.168</span><span class=\"token number\">.241</span><span class=\"token number\">.2</span><span class=\"token operator\">/</span><span class=\"token number\">24</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ol>\n<li>Router id matches the Mikrotik</li>\n<li>Prioty is doubled up to 200 to make this the master</li>\n<li>advert_int is 1 for 1 second</li>\n<li>Authentication match up to the Mikrotik</li>\n</ol>\n<h3>Slow…</h3>\n<p>There was one issue I ran in to. <a href=\"https://pi-hole.net\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Pi-hole</a> service takes a few minutes to start up, mostly combining my huge amount of blacklists from the internet. The problem with this is, if the ip address move over before this complete, I have downtime on the DNS.</p>\n<p>The solution to this, <a href=\"https://www.keepalived.org\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Keepalived</a> isn’t set to auto start, but controlled through a very simplisting bash/cron script, that check if we can resolve dns locally on the <a href=\"https://pi-hole.net\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Pi-hole</a> server before starting up <a href=\"https://www.keepalived.org\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Keepalived</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash</span>\n\n<span class=\"token assign-left variable\">DNSCHECK</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">dig</span> localhost @192.168.241.186 +short<span class=\"token variable\">`</span></span>\n<span class=\"token comment\">#KEEPALIVE=`/etc/init.d/keepalived status | grep started`</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token variable\">$DNSCHECK</span> <span class=\"token operator\">=</span> <span class=\"token string\">'127.0.0.1'</span> <span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">then</span>\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"DNS IS UP!\"</span>\n  /etc/init.d/keepalived status <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> started <span class=\"token operator\">></span> /dev/null\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token variable\">$?</span> <span class=\"token parameter variable\">-ne</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Keepalive not running, lets start it\"</span>\n    /etc/init.d/keepalived zap <span class=\"token operator\">></span> /dev/null\n    /etc/init.d/keepalived start <span class=\"token operator\">></span> /dev/null\n  <span class=\"token keyword\">fi</span>\n<span class=\"token keyword\">else</span>\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"DNS IS DOWN!\"</span>\n  /etc/init.d/keepalived status <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> started <span class=\"token operator\">></span> /dev/null\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token variable\">$?</span> <span class=\"token parameter variable\">-eq</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Keepalive is running, lets stop it\"</span>\n    /etc/init.d/keepalived stop <span class=\"token operator\">></span> /dev/null\n  <span class=\"token keyword\">fi</span>\n<span class=\"token keyword\">fi</span></code></pre></div>\n<h3>END</h3>\n<p>So there you have it. A little bit of work, but makes for a smooth transition between the Pi-hole server and the Mikrotik router. Let me know in the comments what you think.</p>","excerpt":"VRRP  The Virtual Router Redundancy Protocol (VRRP) is a computer networking protocol that provides for automatic assignment of available…","timeToRead":4,"frontmatter":{"date":"May 25, 2019","dateUnformatted":"2019-05-25","path":"/projects/vrrp-between-linux-and-routeros","title":"VRRP between Linux and RouterOS / Mikrotik","category":"projects","tags":["howto","networking","sysadmin"],"author":"David Bezuidenhout","affiliate":"Links to Banggood or Amazon in this article are affiliate links and would support the blog if used to make a purchase.","ogKeywords":"linux, vrrp, routing, mikrotik, routeros","ogDescription":"At home I am running Adguard Home (Pihole alternative) as a DNS resolver, however I wanted to have a backup plan in place in case the machine hosting DNS fail. Here I write about how I let DNS fall back to the Mikrotik Router in such an event.","ogImage":{"publicURL":"/static/f49b047a76499cba25ddf92e4e71e102/vrrp.png"}}}},"pageContext":{}},"staticQueryHashes":["1871841719","1962968773","2237466677","2943769206","316058102","3210670756","3721472473"]}